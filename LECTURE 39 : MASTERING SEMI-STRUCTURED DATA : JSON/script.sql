--IOT_V2_TABLE CREATION

CREATE OR REPLACE DATABASE IOT_DB;
CREATE OR REPLACE SCHEMA IOT_SCHEMA;

create or replace file format iot_csv
type='csv'
compression='none'
field_delimiter=','
field_optionally_enclosed_by='\042' -- double quotes ASCII value
skip_header=1;


create or replace TABLE IOT_DB.IOT_SCHEMA.LOAD_IOTV2_EUEXPERIENCE00320055 
(
	ATOMICCONSENTS VARCHAR(16777216),
	DATA VARIANT,
	ORIGINREGION VARCHAR(16777216),
	REQUESTID VARCHAR(16777216),
	SERIALNUMBER VARCHAR(16777216),
	SOURCE_FILE_NAME VARCHAR(16777216),
	EVENT_LOCAL_TIMESTAMP VARCHAR(16777216)
);

create or replace TABLE LOAD_IOTV2_EUEXPERIENCE00320055_COPY as select * from LOAD_IOTV2_EUEXPERIENCE00320055;

create or replace TABLE IOT_DB.IOT_SCHEMA.LOAD_IOTV2_JPEXPERIENCE00320055 (
	ATOMICCONSENTS VARCHAR(16777216),
	DATA VARIANT,
	ORIGINREGION VARCHAR(16777216),
	REQUESTID VARCHAR(16777216),
	SERIALNUMBER VARCHAR(16777216),
	SOURCE_FILE_NAME VARCHAR(16777216),
	EVENT_LOCAL_TIMESTAMP VARCHAR(16777216)
);

create or replace TABLE LOAD_IOTV2_JPEXPERIENCE00320055_COPY as select * from LOAD_IOTV2_JPEXPERIENCE00320055;
select * from IOT_DB.IOT_SCHEMA.LOAD_IOTV2_EUEXPERIENCE00320055_COPY;

--endMCUtemperature
--startMCUtemperature

create or replace TABLE IOT_DB.IOT_SCHEMA.LOAD_IOTV2_NZEXPERIENCE002F0052 (
	ATOMICCONSENTS VARCHAR(16777216),
	DATA VARIANT,
	ORIGINREGION VARCHAR(16777216),
	REQUESTID VARCHAR(16777216),
	SERIALNUMBER VARCHAR(16777216),
	SOURCE_FILE_NAME VARCHAR(16777216),
	EVENT_LOCAL_TIMESTAMP VARCHAR(16777216)
);

create or replace TABLE LOAD_IOTV2_NZEXPERIENCE002F0052_COPY as select * from LOAD_IOTV2_NZEXPERIENCE002F0052;

----------------------------------------------------AWS (S3) INTEGRATION------------------------------------------------------------------------
create or replace file format iot_csv
type='csv'
compression='none'
field_delimiter=','
field_optionally_enclosed_by='\042' -- double quotes ASCII value
skip_header=1;

CREATE OR REPLACE STORAGE integration iot_si
TYPE = EXTERNAL_STAGE
STORAGE_PROVIDER = S3
ENABLED = TRUE
STORAGE_AWS_ROLE_ARN ='arn:aws:iam::661806635168:role/iotv2_role' 
STORAGE_ALLOWED_LOCATIONS =('s3://aj-iotv2/');

DESC integration iot_si;

CREATE OR REPLACE STAGE iot_stage
URL ='s3://aj-iotv2'
file_format = iot_csv
storage_integration = iot_si;

SHOW STAGES;

LIST @iot_stage;

-------------------------------------------------iotv2_snowpipe--------------------------------------------------------------------

CREATE OR REPLACE PIPE iotv2_snowpipe_EUEXPERIENCE00320055 AUTO_INGEST = TRUE AS
COPY INTO IOT_DB.IOT_SCHEMA.LOAD_IOTV2_EUEXPERIENCE00320055 --yourdatabase -- your schema ---your table
FROM '@iot_stage/IOTV2_EUEXPERIENCE00320055/' --s3 bucket subfolde4r name
FILE_FORMAT = iot_csv; --YOUR CSV FILE FORMAT NAME

CREATE OR REPLACE PIPE iotv2_snowpipe_JPEXPERIENCE00320055 AUTO_INGEST = TRUE AS
COPY INTO IOT_DB.IOT_SCHEMA.LOAD_IOTV2_JPEXPERIENCE00320055
FROM '@iot_stage/IOTV2_JPEXPERIENCE00320055/' 
FILE_FORMAT = iot_csv;

CREATE OR REPLACE PIPE iotv2_snowpipe_NZEXPERIENCE002F0052 AUTO_INGEST = TRUE AS
COPY INTO IOT_DB.IOT_SCHEMA.LOAD_IOTV2_NZEXPERIENCE002F0052
FROM '@iot_stage/IOTV2_NZEXPERIENCE002F0052/' 
FILE_FORMAT = iot_csv;


----------------------------------------------------------PIPEREFRESH-----------------------------------------------------------------

ALTER PIPE iotv2_snowpipe_EUEXPERIENCE00320055 refresh;
ALTER PIPE  iotv2_snowpipe_JPEXPERIENCE00320055 refresh;
ALTER PIPE  iotv2_snowpipe_NZEXPERIENCE002F0052 refresh;

SELECT COUNT(*) FROM LOAD_IOTV2_EUEXPERIENCE00320055;
SELECT COUNT(*) FROM LOAD_IOTV2_JPEXPERIENCE00320055;
SELECT COUNT(*) FROM LOAD_IOTV2_NZEXPERIENCE002F0052;

SELECT * FROM LOAD_IOTV2_EUEXPERIENCE00320055;
SELECT * FROM LOAD_IOTV2_JPEXPERIENCE00320055;
SELECT * FROM LOAD_IOTV2_NZEXPERIENCE002F0052;

